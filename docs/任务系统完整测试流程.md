# 任务系统完整测试流程

## 准备工作

### 1. 重启服务器加载数据
```bash
evennia reload
```

### 2. 检查数据是否加载成功
进入游戏后输入:
```
@py from world.loaders.game_data import GAME_DATA; len(GAME_DATA['quests'])
```
应该看到任务数量(如: `8` 或更多)

---

## 测试1: 基础命令

### 查看任务列表
```
quests
```
预期: 显示 "当前没有进行中的任务"

### 查看已完成任务
```
quests done
```
预期: 显示 "还没有完成过任务"

### 查看每日任务
```
quests daily
```
预期: 显示可用的每日任务列表

---

## 测试2: 接取任务流程

### 方法A: 通过NPC接取 (推荐)

#### 1. 创建测试NPC
```
@create 村长:typeclasses.npcs.NPC
```

#### 2. 与NPC对话
```
talk 村长
```
预期: 显示可接取的任务 "初入江湖"

#### 3. 接取任务
```
accept 初入江湖
```
预期: 提示 "已接取任务: 初入江湖"

### 方法B: 直接接取 (测试用)
```
@py from world.systems.quest_system import QUEST_SYSTEM
@py QUEST_SYSTEM.accept_quest(self, "新手试炼_1")
```

---

## 测试3: 任务进度更新

### 1. 查看当前任务
```
quest
```
预期: 显示任务目标和进度 (0/5)

### 2. 模拟击杀事件
```
@py from world.systems.quest_system import QUEST_SYSTEM
@py for i in range(5): QUEST_SYSTEM.on_kill(self, "野猪")
```
预期: 每次击杀都会收到 "[任务更新]" 提示

### 3. 再次查看任务
```
quest
```
预期: 进度变成 (5/5), 状态变成 "[可交付]"

---

## 测试4: 完成任务

### 方法A: 通过NPC完成
```
talk 村长
```
预期: 显示 "村长 有任务可以交付"

```
complete 初入江湖
```
预期: 显示奖励信息

### 方法B: 直接完成
```
@py from world.systems.quest_system import QUEST_SYSTEM
@py QUEST_SYSTEM.complete_quest(self, "新手试炼_1")
```

### 检查奖励
```
@py self.ndb.inventory
```
预期: 看到 `{'聚气丹': 3, '回春丹': 2}`

---

## 测试5: 任务链

### 1. 完成第一个任务后检查
```
talk 村长
```
预期: 解锁新任务 "收集灵草"

### 2. 接取任务链下一个任务
```
accept 收集灵草
```

### 3. 模拟收集事件
```
@py from world.systems.quest_system import QUEST_SYSTEM
@py for i in range(10): QUEST_SYSTEM.on_collect(self, "灵草", 1)
```

---

## 测试6: 多种目标类型

### 对话任务
```
accept 拜访长老
talk 修炼长老
complete 拜访长老
```

### 探索任务
```
accept 天命之路·觉醒
@py from world.systems.quest_system import QUEST_SYSTEM
@py QUEST_SYSTEM.on_explore(self, "迷雾森林_深处")
```

### 修炼任务
```
accept 每日修炼
@py from world.systems.quest_system import QUEST_SYSTEM
@py QUEST_SYSTEM.on_cultivate(self, 1800)
```

---

## 测试7: 每日任务

### 1. 接取每日任务
```
accept 每日修炼
```

### 2. 完成任务
```
@py QUEST_SYSTEM.on_cultivate(self, 1800)
complete 每日修炼
```

### 3. 尝试再次接取
```
accept 每日修炼
```
预期: 提示 "今日已完成该任务"

### 4. 模拟第二天 (开发测试)
```
@py import datetime; self.db.quests['daily_completed'] = {}
accept 每日修炼
```
预期: 可以再次接取

---

## 测试8: 任务要求检查

### 等级不足
```
@py self.ndb.level = 1
accept 天命之路·觉醒
```
预期: 提示 "等级不足（需要5级）"

### 境界不符
```
@py self.ndb.level = 5; self.ndb.realm = "炼气期"
accept 天命之路·觉醒
```
预期: 提示 "境界不符（需要筑基期）"

### 前置任务未完成
```
accept 新手试炼_2
```
预期: 提示 "需要先完成：初入江湖"

---

## 测试9: 放弃任务

### 1. 接取任务
```
accept 每日猎杀
```

### 2. 放弃任务
```
abandon 每日猎杀
```
预期: 提示 "已放弃任务: 每日猎杀"

### 3. 检查任务列表
```
quests
```
预期: 不再显示该任务

---

## 测试10: 战斗系统集成

### 创建测试怪物
```
@create 野猪:typeclasses.npcs.NPC
@py 野猪 = self.search("野猪"); 野猪.ndb.level = 1
```

### 开始战斗并击杀
```
# (使用你的战斗命令)
attack 野猪
```

### 检查任务进度
如果你接取了 "初入江湖" 任务,击杀后应该自动更新进度

---

## 快速自动化测试

### 使用测试命令 (如果添加了)
```
@testquest           # 完整测试
@testquest quick     # 快速测试
@testquest reset     # 重置数据
```

### 使用测试脚本
```
@py from world.tests.quest_test import test_quest_system
@py test_quest_system(self)
```

---

## 预期结果检查清单

- [ ] 可以查看任务列表
- [ ] 可以接取符合条件的任务
- [ ] 击杀事件正确更新进度
- [ ] 收集事件正确更新进度
- [ ] 对话事件正确更新进度
- [ ] 探索事件正确更新进度
- [ ] 修炼事件正确更新进度
- [ ] 任务完成后正确发放奖励
- [ ] 任务链正确解锁下一个任务
- [ ] 每日任务正确限制重复接取
- [ ] 等级/境界要求正确检查
- [ ] 前置任务要求正确检查
- [ ] 可以放弃任务
- [ ] NPC对话显示任务提示
- [ ] 战斗击杀自动触发任务事件

---

## 常见问题排查

### 问题1: 命令不存在
```
@py self.cmdset.all()
```
检查命令集是否包含任务命令

### 问题2: 任务数据未加载
```
@py from world.loaders.game_data import GAME_DATA
@py list(GAME_DATA['quests'].keys())
```
查看已加载的任务ID

### 问题3: 任务进度不更新
```
@py self.db.quests
```
检查任务数据结构是否正确

### 问题4: 奖励未发放
```
@py self.ndb.inventory
@py self.ndb.skills
```
检查奖励是否存入内存

---

## 压力测试

### 批量接取任务
```
@py from world.systems.quest_system import QUEST_SYSTEM
@py for qid in GAME_DATA['quests'].keys(): QUEST_SYSTEM.accept_quest(self, qid)
```

### 批量完成任务
```
@py for quest in self.db.quests['active']: QUEST_SYSTEM.complete_quest(self, quest['quest_id'])
```

---

## 开发调试命令

### 查看所有任务
```
@py from world.loaders.game_data import GAME_DATA
@py for qid, qdata in GAME_DATA['quests'].items(): print(f"{qid}: {qdata.get('name')}")
```

### 强制完成任务目标
```
@py quest = self.db.quests['active'][0]
@py for obj in quest['objectives']: obj['current'] = obj.get('count', 1)
```

### 清空任务数据
```
@py self.db.quests = {'active': [], 'completed': [], 'failed': [], 'daily_completed': {}}
```