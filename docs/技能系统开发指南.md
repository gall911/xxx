# 技能系统开发指南

## 核心设计理念

当前技能系统采用**数据驱动** + **插件化效果**架构：
- 所有技能配置存储在YAML文件中
- 技能效果通过Python装饰器注册，系统会自动发现
- 技能可以继承模板，减少重复配置

## 真实可用的命令

### 技能相关命令
```
skills                   # 查看已学会的技能
skills <技能key>         # 查看技能详情  
learn <技能key>          # 学习技能
upgrade <技能key>        # 升级技能
equip                    # 查看已装备的技能
equip <槽位> <技能key>  # 装备技能到指定槽位
```

### 调试命令
```
xx get <对象> <属性>     # 查看对象属性（支持me/here/对象名）
xx set <对象> <属性> <值> # 设置对象属性
xx reload data           # 重新加载游戏数据
xx reload config         # 重新加载配置文件
xx data                  # 查看已加载的数据统计
xx data <类型>           # 查看指定类型的所有数据
xx cbug <目标>           # 诊断战斗数据
xx cbug/fix <目标>       # 修复战斗数据问题
```

## 有效的配置字段

### 技能配置字段
```yaml
name: 技能名称           # 必须
desc: 技能描述           # 必须  
type: 技能类型           # 必须 (active/passive)
element: 元素类型        # 可选 (physical/fire/ice/lightning/blood)
range: 攻击范围          # 可选 (melee/short/medium/long)
cast_time: 施法时间      # 可选 (秒)
cooldown: 冷却时间       # 可选 (回合)
cost_qi: 消耗灵力        # 可选
damage: 基础伤害         # 可选 (计算公式结果)
accuracy: 命中率         # 可选 (0-1)
inherit: 继承模板        # 可选
level_formula:          # 可选
  damage:               # 伤害成长
    base: 20
    grow: 0.025
  accuracy:             # 命中率成长
    base: 0.9
    per_level: 0.0005
  max_level: 10
stat_scaling:           # 属性加成
  strength: 1.5         # 力量加成系数
  agility: 0.3           # 敏捷加成系数
effects:                # 效果列表
  - type: damage        # 效果类型
    element: physical   # 元素类型
    value: "{level_damage}" # 数值(支持变量)
    damage_variance: 0.3 # 伤害浮动
battle_text:            # 战斗文本(可选)
  hit: "击中目标"
  miss: "未命中"
  crit: "暴击！"
required_realm: 练气期   # 需求境界(可选)
```

### 装备词条字段
```yaml
stats:                  # 基础属性
  strength: 10          # 力量
  agility: 5            # 敏捷
effects:                # 特殊效果
  - type: stat_boost   # 属性提升
    stat: strength
    value: 15
  - type: life_steal   # 吸血
    value: 0.15
```

## 文件继承关系

```
具体技能文件 (如 fireball.yaml)
    ↓ 继承
基础模板 (如 data/skills/base/magic_combat.yaml)
    ↓ 继承  
系统默认 (硬编码默认值)
```

## 扩展示例

### 1. 纯YAML扩展现有效果
```yaml
# 在现有技能中调整数值
damage: 100                    # 修改基础伤害
effects:
  - type: damage
    value: "{level_damage * 1.5}" # 修改伤害公式
    damage_variance: 0.5        # 修改浮动范围
```

### 2. 创建新技能文件
```yaml
# data/skills/my_fireball.yaml
name: 我的火球术
desc: 自定义的火球术
type: active
element: fire
inherit: magic_combat
damage: 50
cast_time: 2.0
```

### 3. Python代码扩展新效果
```python
# world/systems/skill_effects/my_effects.py
from world.systems.skill_effects.base_effects import register_effect

@register_effect("freeze")
def apply_freeze(caster, target, effect_config, battle):
    """冰冻效果"""
    duration = effect_config.get('duration', 2)
    target.db.frozen = duration
    battle.log(f"{target.name} 被冰冻 {duration} 回合！")

@register_effect("burn")
def apply_burn(caster, target, effect_config, battle):
    """燃烧效果"""
    damage = effect_config.get('damage', 10)
    duration = effect_config.get('duration', 3)
    target.db.burning = {'damage': damage, 'duration': duration}
    battle.log(f"{target.name} 被燃烧！")
```

## 开发注意事项

1. **YAML字段大小写敏感** - 必须严格按照文档中的字段名
2. **继承顺序** - 子类会覆盖父类的相同字段
3. **效果类型必须注册** - 使用未注册的效果类型会被忽略
4. **变量支持** - 支持 `{level_damage}`, `{caster_level}` 等变量
5. **数据类型** - 注意数值、字符串、布尔值的正确格式

## 相关文件索引

- **技能数据**: `data/skills/` - 所有技能配置文件
- **基础模板**: `data/skills/base/` - 技能模板文件  
- **效果实现**: `world/systems/skill_effects/` - 技能效果代码
- **加载器**: `world/loaders/` - 数据和配置加载
- **战斗系统**: `world/systems/combat/` - 战斗逻辑
- **调试命令**: `commands/dev/` - 开发调试命令

## 调试技巧

1. 使用 `xx data skills` 查看所有已加载的技能
2. 使用 `xx get me db.learned_skills` 查看已学会的技能
3. 使用 `xx reload data` 重新加载修改后的技能数据
4. 使用 `xx cbug me` 检查角色的战斗数据完整性

---

**注意**: 本文档只包含100%确认存在的功能和命令。如有疑问，请使用调试命令验证。